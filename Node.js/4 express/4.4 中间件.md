### Node.js 4.4 Express 中间件

1. **中间件的概念**

   中间件（middleware）特指业务流程的中间处理环节。Express 中间件的<font color='red'>调用流程</font>是，当一个请求到达 Express 的服务器之后，可以连续调用多个中间件，从而对这次请求进行<font color='red'>预处理</font>。

   <img src="https://developer.okta.com/assets-jekyll/blog/express-middleware-examples/middleware-30b3b30ad54e21d8281719042860f3edd9fb1f40f93150233a08165d908f4631.png" alt="Build and Understand Express Middleware through Examples | Okta Developer" style="zoom: 67%;" />

   <img src="https://res.cloudinary.com/practicaldev/image/fetch/s--PHYkGiKU--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://dev-to-uploads.s3.amazonaws.com/i/73eusy0bc095c9w8tstw.png" alt="img" style="zoom: 67%;" />

   

2. **Express 中间件的格式**

   Express 的中间件本质上就是一个 function 处理函数（形参和普通函数不同，多了 next）。中间件函数的形参列表中，<font color='red'>必须包含 next 参数</font>。而路由处理函数只包含 req 和 res。

   <font color='red'>next 函数</font>是实现<font color='red'>多个中间件连续调用</font>的关键，它表示把流转关系<font color='red'>转交</font>给下一个<font color='green'>中间件</font>或<font color='green'>路由</font>。在当前中间件的业务处理完毕后，<font color='red'>必须调用 next 函数</font>。

   ```javascript
   const express = require('express')
   const app = express()
   app.get('/', (req, res, next) => {   //中间件函数
       next(); 
   })
   
   app.listen(80, () => {console.log('server running at http://127.0.0.1')})
   ```

   

   定义一个最简单中间件函数

   ```javascript
   const mw = function(req, res, next){
       console.log('This is easist Middleware function');
       next();
   }
   ```

   

3. **全局生效的中间件**

   客户端发起的<font color='red'>任何请求</font>，到达服务器之后，<font color='red'>都会触发的中间件</font>，叫做全局生效的中间件。通过调用  `app.use(中间件函数)` ，即可定义一个<font color='red'>全局生效</font>的中间件：

   ```javascript
   const mw = function(req, res, next){
       console.log('This is easist Middleware function');
       next();
   }
   
   app.use(mw)   //注册为全局生效的中间件
   ```

   其他的路由可以照常写。这样在服务器收到请求后，会先调用中间件函数 mw，再继续匹配调用路由。

   

   全局中间件的简化形式（把函数换成了匿名函数）：

   ```javascript
   app.use(function(req, res, next){
       console.log('This is easist Middleware function');
       next();
   })
   ```

   

4. **中间件在开发中的作用**

   多个中间件之间，<font color='red'>共享同一份 req 和 res</font>。基于这样的特性，我们可以在<font color='red'>上游</font>的中间件中，统一为 req 或 res 对象添加自定义的属性或方法，供<font color='red'>下游</font>的中间件或路由使用。

   例如，在中间件1上添加 `req.a = 10` ， 在中间件2上添加 `res.c = 30` 。这样在最后的路由中，可以通过访问 `req.a` 和 `res.c` 获得属性值。

   比如我们想获得服务器收到请求的时间。如果不用中间件，就需要在每个路由中都写入时间获取函数。若使用中间件，只需在中间件写入时间获取函数，然后将函数值赋给 req.time ，之后路由从 req.time 中取值即可。

   

5. **定义多个全局中间件**

   可以使用 `app.use()` 连续定义多个全局中间件。客户端请求到达服务器之后，<font color='red'>会按照中间件定义的先后顺序依次调用</font>。例如：

   ```javascript
   app.use(function(req, res, next){   //第一个全局中间件
       console.log('call 1st global middleware');
       next();
   })
   app.use(function(req, res, next){   //第二个全局中间件
       console.log('call 2nd global middleware');
       next();
   })
   app.get('/user', (req, res) => {    //请求这个路由，会依次触发上面两个中间件
       res.send('Home page.')
   })
   ```

   

6. **局部生效的中间件**

   <font color='red'>不使用 `app.use()` 定义的中间件，叫做局部生效的中间件</font>，如：

   ```javascript
   const mw1 = function(req, res, next){
       console.log("This is middleware 1")
       next()
   }
   app.get('/', mw1, function(req, res){  //mw1中间件只在当前路由生效。即局部生效的中间件
       res.send('Home page.')
   })
   app.get('/user', function(req, res){  //mw1中间件不会影响下面路由。
       res.send('User page.')
   })
   ```

   

7. **定义多个局部中间件**

   代码中这两种方式是等价的。

   ```javascript
   app.get('/', mw1, mw2, function(req, res){ res.send('Home page.') })
   app.get('/', [mw1, mw2], function(req, res){ res.send('Home page.') })
   ```

   

8. **注意事项**

   1. 一定要在路由之前注册中间件。因为是从上到下匹配，路由响应后不再匹配。

   2. 客户端发送来的请求可以连续调用多个中间件处理。

   3. 中间件执行后必须调用 next 函数。不调用的话，请求就无法向后继续处理。

   4. 为了防止代码逻辑混乱，调用 next 函数后就不要再写代码。

   5. 连续调用多个中间件时，多个中间件之间共享 req 和 res 对象。

      

9. 